openapi: 3.0.3
info:
  title: Pazaryeri Entegrasyon - EInvoice API
  version: "1.0.0"
  description: |
    E-Invoice API for Pazaryeri Entegrasyon.

    Base path: `/api/v1`

    Requirements:
    - Bearer token authentication (Laravel Sanctum personal access tokens)
    - Module must be active: `feature.einvoice_api`

servers:
  - url: "{baseUrl}"
    description: Base URL (configure per environment)
    variables:
      baseUrl:
        default: http://localhost

tags:
  - name: Einvoices
    description: E-Invoice listing and details
  - name: Provider
    description: Provider/integrator callbacks

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: Token

  schemas:
    ErrorResponse:
      type: object
      properties:
        message:
          type: string
      required: [message]

    ValidationErrorResponse:
      type: object
      properties:
        message:
          type: string
        errors:
          type: object
          additionalProperties:
            type: array
            items:
              type: string
      required: [message, errors]

    Buyer:
      type: object
      properties:
        name: { type: string, nullable: true }
        email: { type: string, nullable: true }
        phone: { type: string, nullable: true }

    Totals:
      type: object
      properties:
        subtotal: { type: number, format: float }
        tax_total: { type: number, format: float }
        discount_total: { type: number, format: float }
        grand_total: { type: number, format: float }
        currency: { type: string }
      required: [subtotal, tax_total, discount_total, grand_total, currency]

    EInvoiceListItem:
      type: object
      properties:
        id: { type: integer, format: int64 }
        invoice_no: { type: string, nullable: true }
        status:
          type: string
          description: Invoice status
          example: issued
        type:
          type: string
          description: Invoice type
          example: sale
        issued_at:
          type: string
          format: date-time
          nullable: true
        marketplace: { type: string, nullable: true }
        marketplace_order_no: { type: string, nullable: true }
        buyer:
          $ref: "#/components/schemas/Buyer"
        totals:
          $ref: "#/components/schemas/Totals"
        pdf_url:
          type: string
          format: uri
        updated_at:
          type: string
          format: date-time
          nullable: true
      required: [id, invoice_no, status, type, issued_at, marketplace, marketplace_order_no, buyer, totals, pdf_url, updated_at]

    PaginationMeta:
      type: object
      properties:
        current_page: { type: integer }
        per_page: { type: integer }
        total: { type: integer }
        last_page: { type: integer }
      required: [current_page, per_page, total, last_page]

    EInvoiceListResponse:
      type: object
      properties:
        data:
          type: array
          items:
            $ref: "#/components/schemas/EInvoiceListItem"
        meta:
          $ref: "#/components/schemas/PaginationMeta"
      required: [data, meta]

    EInvoiceItem:
      type: object
      properties:
        id: { type: integer, format: int64 }
        sku: { type: string, nullable: true }
        name: { type: string }
        quantity: { type: number, format: float }
        unit_price: { type: number, format: float }
        vat_rate: { type: number, format: float }
        vat_amount: { type: number, format: float }
        discount_amount: { type: number, format: float }
        total: { type: number, format: float }
      required: [id, sku, name, quantity, unit_price, vat_rate, vat_amount, discount_amount, total]

    EInvoiceEvent:
      type: object
      properties:
        id: { type: integer, format: int64 }
        type: { type: string }
        payload:
          type: object
          nullable: true
          additionalProperties: true
        created_at:
          type: string
          format: date-time
          nullable: true
      required: [id, type, payload, created_at]

    EInvoiceDetailResponse:
      allOf:
        - $ref: "#/components/schemas/EInvoiceListItem"
        - type: object
          properties:
            items:
              type: array
              items:
                $ref: "#/components/schemas/EInvoiceItem"
            events:
              type: array
              items:
                $ref: "#/components/schemas/EInvoiceEvent"

    ProviderStatusRequest:
      type: object
      properties:
        provider_status:
          type: string
          maxLength: 100
        provider_invoice_id:
          type: string
          maxLength: 255
          nullable: true
        raw:
          type: object
          nullable: true
          additionalProperties: true
      required: [provider_status]

security:
  - bearerAuth: []

paths:
  /api/v1/einvoices:
    get:
      tags: [Einvoices]
      summary: List e-invoices
      description: Lists invoices for the authenticated user.
      parameters:
        - in: query
          name: status
          schema: { type: string }
        - in: query
          name: marketplace
          schema: { type: string }
        - in: query
          name: type
          schema: { type: string }
        - in: query
          name: updated_since
          description: ISO-8601 datetime is recommended.
          schema: { type: string }
        - in: query
          name: per_page
          schema: { type: integer, minimum: 1, maximum: 100, default: 20 }
        - in: query
          name: page
          schema: { type: integer, minimum: 1 }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EInvoiceListResponse"
        "401":
          description: Unauthenticated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (module not active)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/v1/einvoices/{einvoice}:
    get:
      tags: [Einvoices]
      summary: Get e-invoice detail
      parameters:
        - in: path
          name: einvoice
          required: true
          schema: { type: integer, format: int64 }
        - in: query
          name: include_items
          schema: { type: boolean, default: true }
        - in: query
          name: include_events
          schema: { type: boolean, default: false }
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EInvoiceDetailResponse"
        "401":
          description: Unauthenticated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found (or not owned by user)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/v1/einvoices/{einvoice}/pdf:
    get:
      tags: [Einvoices]
      summary: Download invoice PDF
      parameters:
        - in: path
          name: einvoice
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "200":
          description: PDF file
          content:
            application/pdf:
              schema:
                type: string
                format: binary
        "401":
          description: Unauthenticated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found (or PDF missing)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

  /api/v1/einvoices/{einvoice}/provider-status:
    post:
      tags: [Provider]
      summary: Update provider status for an invoice
      description: Requires ability `einvoices:status` in the token.
      parameters:
        - in: path
          name: einvoice
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProviderStatusRequest"
      responses:
        "200":
          description: Updated invoice
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EInvoiceListItem"
        "401":
          description: Unauthenticated
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "403":
          description: Forbidden (missing ability)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "404":
          description: Not found (or not owned by user)
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }
        "422":
          description: Validation error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ValidationErrorResponse" }
        "500":
          description: Server error
          content:
            application/json:
              schema: { $ref: "#/components/schemas/ErrorResponse" }

