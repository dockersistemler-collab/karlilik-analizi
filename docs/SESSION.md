# Session Memory

**Last updated:** 2026-02-06

## Mail Altyapısı Özeti
- Akış: Event -> Listener (ShouldQueue) -> MailSender -> mail_logs
- Policy hook: MailPolicyService + mail_rule_assignments
- Admin panel: mail logları ve mail template yönetimi

## Tamamlanan Mail Senaryoları (M001-M012)
- M001: Support view bildirimi
  - Event: app/Events/SupportViewStarted.php
  - Listener: app/Listeners/SendSupportViewStartedMail.php
  - Template: security.support_view_used
  - Dispatch: app/Services/Admin/SupportViewService.php::start
  - Dedupe: yok
  - Test: tests/Feature/Mail/SupportViewStartedMailTest.php
- M002: Pazaryeri bağlantısı koptu
  - Event: app/Events/MarketplaceConnectionLost.php
  - Listener: app/Listeners/SendMarketplaceConnectionLostMail.php
  - Template: mp.connection_lost
  - Dispatch: app/Services/Marketplace/Category/TrendyolCategoryProvider.php::fetchCategoryTree
  - Dedupe: yok
  - Test: tests/Feature/Mail/MarketplaceConnectionLostMailTest.php
- M003: Ödeme başarısız
  - Event: app/Events/PaymentFailed.php
  - Listener: app/Listeners/SendPaymentFailedMail.php
  - Template: payment.failed
  - Dispatch: app/Http/Controllers/Payments/IyzicoCheckoutCallbackController.php::__invoke
  - Dedupe: error_code bazlı 30 dk
  - Test: tests/Feature/Mail/PaymentFailedMailTest.php
- M004: Trial bitti
  - Event: app/Events/TrialEnded.php
  - Listener: app/Listeners/SendTrialEndedMail.php
  - Template: trial.ended
  - Dispatch: app/Console/Commands/SubscriptionMaintenanceCommand.php::handle
  - Dedupe: user bazlı 24 saat
  - Test: tests/Feature/Mail/TrialEndedMailTest.php
- M005: Kota aşıldı
  - Event: app/Events/QuotaExceeded.php
  - Listener: app/Listeners/SendQuotaExceededMail.php
  - Template: quota.exceeded
  - Dispatch: app/Http/Controllers/Admin/ProductController.php::store
  - Dedupe: quota_key + period bazlı 24 saat
  - Test: tests/Feature/Mail/QuotaExceededMailTest.php
- M006: Ödeme başarılı
  - Event: app/Events/PaymentSucceeded.php
  - Listener: app/Listeners/SendPaymentSucceededMail.php
  - Template: payment.succeeded
  - Dispatch: app/Http/Controllers/Payments/IyzicoCheckoutCallbackController.php::__invoke
  - Dedupe: transaction_id varsa tekrar yok, yoksa occurred_at dakika bazlı
  - Test: tests/Feature/Mail/PaymentSucceededMailTest.php
- M007: Kota %80 uyarısı
  - Event: app/Events/QuotaWarningReached.php
  - Listener: app/Listeners/SendQuotaWarningMail.php
  - Template: quota.warning_80
  - Dispatch: app/Http/Controllers/Admin/ProductController.php::store
  - Dispatch: app/Http/Controllers/Admin/IntegrationController.php::update
  - Dispatch: app/Observers/OrderObserver.php::created
  - Dedupe: user + quota_type + period bazlı 7 gün
  - Test: tests/Feature/Mail/QuotaWarningReachedMailTest.php
- M008: Fatura oluşturuldu
  - Event: app/Events/InvoiceCreated.php
  - Listener: app/Listeners/SendInvoiceCreatedMail.php
  - Template: invoice.created
  - Dispatch: app/Services/EInvoices/EInvoiceService.php::issue
  - Dedupe: invoice_id bazlı
  - Test: tests/Feature/Mail/InvoiceCreatedMailTest.php
- M009: Fatura oluşturulamadı
  - Event: app/Events/InvoiceFailed.php
  - Listener: app/Listeners/SendInvoiceFailedMail.php
  - Template: invoice.failed
  - Dispatch: app/Services/EInvoices/EInvoiceService.php::issue (catch)
  - Dedupe: invoice_id bazlı
  - Test: tests/Feature/Mail/InvoiceFailedMailTest.php
- M010: Token bitişi yaklaşıyor
  - Event: app/Events/MarketplaceTokenExpiring.php
  - Listener: app/Listeners/SendMarketplaceTokenExpiringMail.php
  - Template: mp.token_expiring
  - Dispatch: app/Console/Commands/CheckMarketplaceTokenExpirationsCommand.php::handle
  - Dedupe: marketplace_credential_id + days_left bazlı 24 saat
  - Test: tests/Feature/Mail/MarketplaceTokenExpiringMailTest.php
- M011: Abonelik başladı
  - Event: app/Events/SubscriptionStarted.php
  - Listener: app/Listeners/SendSubscriptionStartedMail.php
  - Template: subscription.started
  - Dispatch: app/Http/Controllers/SubscriptionController.php::store, app/Http/Controllers/SubscriptionController.php::renew
  - Dedupe: subscription_id bazlı
  - Test: tests/Feature/Mail/SubscriptionStartedMailTest.php
- M012: Abonelik yenilendi
  - Event: app/Events/SubscriptionRenewed.php
  - Listener: app/Listeners/SendSubscriptionRenewedMail.php
  - Template: subscription.renewed
  - Dispatch: app/Http/Controllers/SubscriptionController.php::store
  - Dedupe: subscription_id + period_end veya renewed_at bazlı
  - Test: tests/Feature/Mail/SubscriptionRenewedMailTest.php

Not:
- subscription.cancelled senaryosu ayrıca mevcut.
  - Event: app/Events/SubscriptionCancelled.php
  - Listener: app/Listeners/SendSubscriptionCancelledMail.php
  - Template: subscription.cancelled
  - Dispatch: app/Http/Controllers/SubscriptionController.php::cancel
  - Dedupe: subscription_id bazlı
  - Test: tests/Feature/Mail/SubscriptionCancelledMailTest.php

## Scheduler
- marketplace:check-token-expirations dailyAt 09:00 Europe/Istanbul

## Bildirim Merkezi (Notification Hub)
- Tablolar (migration):
  - app_notifications
  - notification_preferences
  - notification_audit_logs
- Modeller/Enumlar/Servisler:
  - app/Models/Notification.php
  - app/Models/NotificationPreference.php
  - app/Models/NotificationAuditLog.php
  - app/Enums/NotificationType.php
  - app/Enums/NotificationChannel.php
  - app/Enums/NotificationSource.php

## Sistem Ayarları (Super Admin)
- Mail & Bildirim Ayarları sekmesi eklendi.
- system_settings tablosu + SettingsRepository ile DB tabanlı mail override ve test mail akışı.
- Incident & SLA ayarları artık super-admin Sistem Ayarları’ndan yönetilir; incident_sla config defaultları override edilir.
- Integration Health eşikleri artık super-admin Sistem Ayarları’ndan yönetilir; integration_health config defaultları DB ile override edilir.
- Feature gating: plan bazli plan_matrix (system_settings: features.plan_matrix), FeatureGate + EnsureFeatureEnabled ve admin upgrade ekranı.
- Billing MVP eklendi: plan katalogu system_settings billing.plans_catalog; admin billing/plans + checkout stub + success ile tenant plan_code guncellenir (user.plan_code legacy).
- Iyzico checkout init eklendi: iyzico.enabled true ise checkout iframe formu basiliyor; callback/webhook sonraki adimda.
- Iyzico callback + webhook eklendi: callback token ile API retrieve dogrular, webhook signature HMAC ile dogrular ve idempotent completion yapar. Webhook secret olmadan 400 doner.
- Iyzico Subscription MVP eklendi: billing_subscriptions + billing_subscription_events, abonelik webhook'u ile retrieveSubscription dogrular. Subscription ozelligi hesapta aktif olmalidir (sandbox dahil). Upgrade ayni product + ayni interval kurali. Webhook idempotent; downgrade politikasi MVP: canceled/unpaid -> free.
- Son is: Subscription testleri fixlendi (SDK model method uyumu), webhook imza testinde header gonderimi duzeltildi. Tum ilgili testler PASS.
- Incident Inbox eklendi: unassigned varsayilan filtre, quick assign/ack aksiyonlari ve SLA filtreleri (incident_sla aciksa).
  - app/Services/Notifications/NotificationService.php
  - app/Services/Notifications/PreferenceResolver.php
  - app/Services/Notifications/DedupeService.php
  - app/Jobs/SendNotificationEmailJob.php
  - app/Mail/NotificationHubMail.php
  - resources/views/emails/notification-hub.blade.php
- Event -> Listener örnekleri:
  - app/Events/OrderSyncFailed.php -> app/Listeners/NotificationHub/SendOrderSyncFailedNotification.php
  - app/Events/StockSyncFailed.php -> app/Listeners/NotificationHub/SendStockSyncFailedNotification.php
  - app/Events/InvoiceCreationFailed.php -> app/Listeners/NotificationHub/SendInvoiceCreationFailedNotification.php
  - app/Events/MarketplaceTokenExpired.php -> app/Listeners/NotificationHub/SendMarketplaceTokenExpiredNotification.php
  - app/Events/WebhookSignatureInvalid.php -> app/Listeners/NotificationHub/SendWebhookSignatureInvalidNotification.php
- Policy/Composer:
  - app/Policies/NotificationPolicy.php
  - app/Policies/NotificationPreferencePolicy.php
  - app/Providers/AppServiceProvider.php: bildirim sayacı + bell route paylaşımı
- Routes (notification-hub namespace):
  - routes/customer.php: admin.notification-hub.*
  - routes/admin.php: super-admin.notification-hub.*
- Views:
  - resources/views/partials/notification-bell.blade.php
  - resources/views/admin/notification-hub/index.blade.php
  - resources/views/admin/notification-hub/partials/_filters.blade.php
  - resources/views/admin/notification-hub/partials/_item.blade.php
  - resources/views/admin/notification-hub/preferences.blade.php
  - super-admin notification hub view
- Layout include:
  - resources/views/layouts/admin.blade.php
  - super-admin layout view
- Middleware/support izinleri:
  - config/support.php: admin.notification-hub.notifications.index + admin.notification-hub.preferences.index
  - app/Http/Middleware/EnsureSubUserPermission.php: admin.notification-hub.* => settings
- Varsayılan filtre:
  - Son 30 gün (admin + super-admin)
- Factories & Tests:
  - database/factories/NotificationFactory.php
  - database/factories/NotificationPreferenceFactory.php
  - tests/Feature/Notifications/NotificationHubTest.php
- README notu:
  - README.md Notification Hub bölümü eklendi

## Son İşlemler
- Prod readiness runbook eklendi:
  - docs/PROD.md (deployment, queue/scheduler, webhook, monitoring, backups, domain/SSL, smoke test)
- php artisan test: PASS (242 tests).
- Portal fatura ekranları terminoloji sadeleştirildi:
  - resources/views/customer/invoices/index.blade.php (Faturalar, kolonlar: Tarih/Tutar/Durum/Dönem, Detay)
  - resources/views/customer/invoices/show.blade.php (Fatura Detayı, PDF İndir vb.)
- Portal billing/çeşitli view ve servislerde bozuk ?? ifadeleri temizlendi (parse error fixleri):
  - NotificationService, BillingEventLogger, IyzicoClient, SettingsController, input-label, register, admin billing/plans, einvoices pdf vb.
- Queueable çakışması fix:
  - app/Jobs/SyncMarketplaceCategoriesJob.php: $queue property kaldırıldı, constructor’da onQueue('integrations')
- php artisan test: PASS (pdo_sqlite olmayan ortamlarda bazı testler WARN/skip).
- Admin Billing Events izleme ekranı eklendi:
  - routes/customer.php: /admin/observability/billing-events (super_admin)
  - app/Http/Controllers/Admin/BillingEventController.php
  - resources/views/admin/observability/billing_events/index|show.blade.php
  - tests: BillingEventAdminIndexTest, BillingEventAdminFiltersTest
- Observability eklendi:
  - CorrelationIdMiddleware + correlation alias + AppServiceProvider queue/command propagation.
  - billing_events tablosu + BillingEvent modeli + BillingEventLogger servisi.
  - Iyzico webhook/dunning ve invoice create/paid noktalarında billing event loglama.
- Customer invoice portal eklendi:
  - routes/customer.php altında invoices list/show/download (signed+throttle).
  - InvoicePolicy + Customer InvoiceController + customer invoice blade’leri.
- API token expired davranışı düzeltildi:
  - EnsureApiTokenValid middleware priority auth öncesine alındı (bootstrap/app.php).
- Testler eklendi ve çalıştırıldı:
  - CustomerInvoicePortalTest, InvoiceDownloadSignedTest, BillingCorrelationIdTest.
  - php artisan test: PASS (sqlite uyarıları bazı webhook testlerinde).
- Billing dunning/grace period eklendi:
  - billing_subscriptions: past_due_since, grace_until, last_dunning_sent_at + index
  - Sistem Ayarları (billing) dunning alanları + UI
  - Iyzico webhook sync: UNPAID/PAST_DUE grace set, ACTIVE reset, CANCELED downgrade
  - Command: billing:dunning-run (hourly) + reminder/downgrade notifications
  - Tests: tests/Feature/SubscriptionDunningTest.php
- Iyzico catalog auto-create eklendi (super-admin billing plans):
  - IyzicoSubscriptionClient createProduct/createPricingPlan
  - Routes: super-admin.system-settings.billing.iyzico.*
  - UI: billing_plans partial butonlar + JS (product/pricing ref otomatik doldurma)
  - Test: tests/Feature/SuperAdminIyzicoCatalogAutoCreateTest.php
- Not: Pricing plan interval MVP olarak MONTHLY sabit.
- Not: Upgrade stratejisi için tek product + çok pricing plan önerilir.
- Iyzico card update callback hardening:
  - token/state zorunlu ve provider_token ile esleme
  - duplicate callback ignore + BillingEvent log (card_update.callback_duplicate)
  - bilinmeyen token ignore + BillingEvent log (card_update.callback_unknown_token)
  - billing_events.tenant_id artik nullable; unknown/duplicate eventlerde tenant_id null yazilir
- Testler eklendi:
  - tests/Feature/IyzicoCardUpdateCallbackUnknownTokenTest.php
  - tests/Feature/IyzicoCardUpdateCallbackDuplicateTest.php
- php artisan test: PASS (sqlite uyarilari bazı webhook testlerinde).
- app_notifications hatası için migration çalıştırıldı:
  - php artisan migrate
- ParseError fix:
  - super-admin plans edit view: fazla @endforeach kaldırıldı.
- Notification Hub deliverability testleri eklendi:
  - tests/Feature/NotificationHubDeliverabilityTest.php
- Quiet hours için email job dispatch gecikmesi eklendi:
  - app/Services/Notifications/NotificationService.php
- Email job retry/backoff ayarları eklendi:
  - app/Jobs/SendNotificationEmailJob.php
- Email suppression altyapısı eklendi (DB + servis + admin ekran):
  - database/migrations/2026_02_05_120000_create_email_suppressions_table.php
  - app/Models/EmailSuppression.php
  - app/Services/Notifications/EmailSuppressionService.php
  - app/Http/Controllers/Admin/NotificationSuppressionController.php
  - resources/views/admin/notification-hub/suppressions/*
- Notification audit log action enum genişletildi:
  - database/migrations/2026_02_05_120010_expand_notification_audit_log_actions.php
- Suppression + audit log entegrasyonu (dispatch/defer/fail):
  - app/Services/Notifications/NotificationService.php
  - app/Jobs/SendNotificationEmailJob.php
- Email suppression testleri eklendi:
  - tests/Feature/EmailSuppressionTest.php
- Integration Health (MVP) eklendi:
  - config/integration_health.php (stale_minutes, degraded_error_threshold, window_hours)
  - app/Services/IntegrationHealthService.php (app_notifications + stock last_sync_at + token_expires_at)
  - resources/views/admin/integrations/health/*
  - routes: admin.integrations.health
  - tests/Feature/IntegrationHealthTest.php
- Integration Health bildirimleri eklendi:
  - app/Services/IntegrationHealthNotifier.php
  - app/Console/Commands/IntegrationHealthNotify.php
  - routes/console.php schedule: integrations:health-notify (10 dk)
  - tests/Feature/IntegrationHealthNotificationTest.php
- Incident (Olay) sistemi eklendi:
  - database/migrations/2026_02_05_150000_create_incidents_table.php
  - database/migrations/2026_02_05_150010_create_incident_events_table.php
  - database/migrations/2026_02_05_150020_expand_notification_audit_log_actions_for_incidents.php
  - app/Models/Incident.php, app/Models/IncidentEvent.php
  - app/Services/IncidentService.php
  - app/Services/IntegrationHealthNotifier.php (incident open/touch + event + incident_id data)
  - resources/views/admin/incidents/*
  - routes: admin.incidents.*
  - tests/Feature/IncidentTest.php
- Incident SLA/Ownership (MVP) eklendi:
  - config/incident_sla.php (ack/resolve SLA)
  - incidents: assigned_to_user_id + acknowledged_at
  - admin UI owner + SLA badge + MTTA/MTTR
  - tests/Feature/IncidentSlaOwnershipTest.php
- Audit action artik string; enum kullanilmiyor.

## Next steps
- Kullanıcı bildirirse kalan Türkçe karakter/encoding sorunlarını noktasal düzelt.
- Bildirim merkezi ekranlarında kalan UX/iyileştirmeler varsa toparla.
- Super-admin panel düzenleme (menü ve sayfa tutarlılığı) için kapsam çıkar.
- Gerekirse Notification Hub için ek testler (UI route 200) ekle.
- Yeni deliverability testlerini çalıştır:
  - php artisan test --filter=NotificationHubDeliverabilityTest
- Email suppression testlerini çalıştır:
  - php artisan test --filter=EmailSuppressionTest
- Integration Health testlerini çalıştır:
  - php artisan test --filter=IntegrationHealthTest
